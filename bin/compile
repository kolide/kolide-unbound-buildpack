#!/usr/bin/env bash

# Fail fast
set -o pipefail
set -eu

# Arguments
BUILD_DIR=$1
CACHE_DIR=$2
ENV_DIR=$3
BIN_DIR=$(dirname "$0")
CONF_DIR=$(cd "$BIN_DIR"; cd ../conf; pwd)
UNBOUND_JSON_FILE=$ENV_DIR/UNBOUND_JSON

# Expected formatting for buildpack output
function topic() {
  echo "-----> $*"
}

function indent() {
  c='s/^/       /'
  case $(uname) in
    Darwin) sed -l "$c";;
    *)      sed -u "$c";;
  esac
}

# Perform compile steps
topic "Confirming unbound is already installed"
$BUILD_DIR/.apt/usr/sbin/unbound -V | indent

topic "Creating unbound config"
UNBOUND_CONF_DIR=$BUILD_DIR/.apt/etc/unbound
cp $CONF_DIR/unbound.conf $UNBOUND_CONF_DIR/
CONF_FILE=$UNBOUND_CONF_DIR/unbound.conf
echo -e "    chroot: $BUILD_DIR/.apt" >> $CONF_FILE

topic "Set up unbound-control"
$BUILD_DIR/.apt/usr/sbin/unbound-control-setup -d $UNBOUND_CONF_DIR
# Create a temporary config copy where we set the port
CONF_FILE_COPY=$UNBOUND_CONF_DIR/unbound-temp.conf
cp $CONF_FILE $CONF_FILE_COPY
echo -e "    port: 5000" >> $CONF_FILE_COPY # Set port to a high number so that unbound can run in this context
echo -e "    use-syslog: no" >> $CONF_FILE_COPY
LOGFILE=$UNBOUND_CONF_DIR/unbound.log
touch $LOGFILE
echo -e "    logfile: /etc/unbound/unbound.log" >> $CONF_FILE_COPY
# Add in the remote-control option to both files
echo -e "remote-control:" >> $CONF_FILE
echo -e "remote-control:" >> $CONF_FILE_COPY
echo -e "    control-enable: yes" >> $CONF_FILE
echo -e "    control-enable: yes" >> $CONF_FILE_COPY
cat $CONF_FILE_COPY | indent
$BUILD_DIR/.apt/usr/sbin/unbound -vvv -c $CONF_FILE_COPY # Start unbound so that it will respond to unbound-control
sleep 10

# TODO RM: skip if UNBOUND_JSON_FILE is empty
topic "Adding forward list from UNBOUND_JSON config variable"
readarray -t forward_add_arg_list < <(jq -r '.forward[] | "\(.zone) \(.addrs | join (" "))"' $UNBOUND_JSON_FILE)
for forward_add_args in "${forward_add_arg_list[@]}"; do
    $BUILD_DIR/.apt/usr/sbin/unbound-control forward_add "$forward_add_args" -c $CONF_FILE
done

topic "Confirm config file"
cat $CONF_FILE | indent
$BUILD_DIR/.apt/usr/sbin/unbound-checkconf $CONF_FILE | indent

topic "Configuring unbound to run as daemon"
mkdir -p $BUILD_DIR/.profile.d
cp "$BIN_DIR/unbound.sh" "$BUILD_DIR/.profile.d/"
chmod +x "$BUILD_DIR/.profile.d/unbound.sh"

topic "Done"
exit 0
