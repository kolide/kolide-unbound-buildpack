#!/usr/bin/env bash

# Fail fast
set -o pipefail
set -eu

# Arguments
BUILD_DIR=$1
CACHE_DIR=$2
ENV_DIR=$3
BIN_DIR=$(dirname "$0")
CONF_DIR=$(cd "$BIN_DIR"; cd ../conf; pwd)
UNBOUND_JSON_FILE=$ENV_DIR/UNBOUND_JSON

# Expected formatting for buildpack output
function topic() {
  echo "-----> $*"
}

function indent() {
  c='s/^/       /'
  case $(uname) in
    Darwin) sed -l "$c";;
    *)      sed -u "$c";;
  esac
}

# Perform compile steps
topic "Confirming unbound is already installed"
$BUILD_DIR/.apt/usr/sbin/unbound -V | indent

topic "Creating unbound config"
CHROOT=$BUILD_DIR/.apt
cp $CONF_DIR/unbound.conf $CHROOT/etc/unbound
CONF_FILE=$CHROOT/etc/unbound/unbound.conf

topic "Set chroot"
echo -e "    chroot: $CHROOT" >> $CONF_FILE
echo -e "    pidfile: $CHROOT/etc/unbound/unbound.pid" >> $CONF_FILE

topic "Disable IPv6 in unbound config to accommodate Heroku"
echo -e "    do-ip6: no" >> $CONF_FILE

topic "Adding forward list from UNBOUND_JSON config variable"
for row in $(jq -c '.forward[]' $UNBOUND_JSON_FILE); do
    zone=$(echo ${row} | jq -r '.zone')

    echo -e "    forward-zone:" >> $CONF_FILE
    echo -e "        name: \"$zone\"" >> $CONF_FILE

    for addr in $(echo ${row} | jq -r '.addrs[]'); do
        echo -e "        forward-addr: $addr" >> $CONF_FILE
    done

    echo -e "        forward-no-cache: yes" >> $CONF_FILE
done

topic "Confirm config file"
cat $CONF_FILE | indent

topic "Configuring unbound to run as daemon"
mkdir -p $BUILD_DIR/.profile.d
cp "$BIN_DIR/unbound.sh" "$BUILD_DIR/.profile.d/"
chmod +x "$BUILD_DIR/.profile.d/unbound.sh"

topic "Done"
exit 0
